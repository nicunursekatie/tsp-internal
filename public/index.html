<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSP Ideas Hub - The Sandwich Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•™</text></svg>">
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    /* Brand Colors:
       Primary: #236383 (dark blue)
       Secondary: #007e8c (teal)
       Accent: #47b3cb (light teal)
       Highlight: #fbad3f (orange)
       Alert: #a31c41 (burgundy)
    */
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ============================================================================
    // FIREBASE CONFIGURATION
    // Replace these values with your Firebase project config
    // Get these from: Firebase Console ‚Üí Project Settings ‚Üí Your Apps ‚Üí Web App
    // ============================================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBZkzGNKb9u6rLPakz-i2vlzLGyokuSvuk",
      authDomain: "tsp-ideas-hub.firebaseapp.com",
      projectId: "tsp-ideas-hub",
      storageBucket: "tsp-ideas-hub.firebasestorage.app",
      messagingSenderId: "276826956909",
      appId: "1:276826956909:web:a2207c7be0b79dd33a4b64"
    };

    // Initialize Firebase (assign to window only to avoid duplicate declarations when Babel-compiled script runs in global scope)
    firebase.initializeApp(firebaseConfig);
    window.firebaseAuth = firebase.auth();
    window.firebaseDb = firebase.firestore();
  </script>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, Fragment } = React;

    // Simple SVG Icon Components (replacing lucide-react for reliability)
    const Icon = ({ d, size = 18, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
    );
    const Users = ({ size, className }) => <Icon size={size} className={className} d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />;
    const Plus = ({ size, className }) => <Icon size={size} className={className} d="M12 5v14M5 12h14" />;
    const MessageSquare = ({ size, className }) => <Icon size={size} className={className} d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />;
    const CheckCircle = ({ size, className }) => <Icon size={size} className={className} d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3" />;
    const Clock = ({ size, className }) => <Icon size={size} className={className} d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zM12 6v6l4 2" />;
    const AlertTriangle = ({ size, className }) => <Icon size={size} className={className} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01" />;
    const LogOut = ({ size, className }) => <Icon size={size} className={className} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />;
    const Home = ({ size, className }) => <Icon size={size} className={className} d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />;
    const FileText = ({ size, className }) => <Icon size={size} className={className} d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8" />;
    const Vote = ({ size, className }) => <Icon size={size} className={className} d="M22 10h-6M2 10h6M12 2v6M12 16v6M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M19.07 4.93l-4.24 4.24M9.17 14.83l-4.24 4.24" />;
    const Gavel = ({ size, className }) => <Icon size={size} className={className} d="M14.5 9.5L9 15M9.5 5.5L4 11M2 22l3-3M22 2l-3 3M8.5 8.5l7-7M15.5 15.5l-7 7" />;
    const Play = ({ size, className }) => <Icon size={size} className={className} d="M5 3l14 9-14 9V3z" />;
    const Archive = ({ size, className }) => <Icon size={size} className={className} d="M21 8v13H3V8M1 3h22v5H1zM10 12h4" />;
    const ChevronRight = ({ size, className }) => <Icon size={size} className={className} d="M9 18l6-6-6-6" />;
    const ThumbsUp = ({ size, className }) => <Icon size={size} className={className} d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3" />;
    const Send = ({ size, className }) => <Icon size={size} className={className} d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />;
    const X = ({ size, className }) => <Icon size={size} className={className} d="M18 6L6 18M6 6l12 12" />;
    const Calendar = ({ size, className }) => <Icon size={size} className={className} d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM16 2v4M8 2v4M3 10h18" />;
    const User = ({ size, className }) => <Icon size={size} className={className} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />;
    const Target = ({ size, className }) => <Icon size={size} className={className} d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zM12 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12zM12 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" />;
    const DollarSign = ({ size, className }) => <Icon size={size} className={className} d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />;
    const Loader2 = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size || 18} height={size || 18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className || ""}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
    const UsersIcon = Users;

    // Firebase references
    const auth = window.firebaseAuth;
    const db = window.firebaseDb;

    // ============================================================================
    // CONSTANTS
    // ============================================================================

    const WORKFLOW_STAGES = {
      SUBMITTED: { id: 'submitted', label: 'Submitted', icon: FileText, color: 'bg-blue-500', description: 'Awaiting team feedback' },
      FEEDBACK: { id: 'feedback', label: 'Feedback Period', icon: MessageSquare, color: 'bg-purple-500', description: '5-day feedback window' },
      SECONDED: { id: 'seconded', label: 'Seconded', icon: ThumbsUp, color: 'bg-indigo-500', description: 'Ready for review meeting' },
      IN_REVIEW: { id: 'in_review', label: 'In Review', icon: Vote, color: 'bg-yellow-500', description: 'Being discussed at review meeting' },
      DECIDED: { id: 'decided', label: 'Decided', icon: Gavel, color: 'bg-orange-500', description: 'Decision made, may be appealed' },
      IN_PROGRESS: { id: 'in_progress', label: 'In Progress', icon: Play, color: 'bg-green-500', description: 'Being implemented' },
      COMPLETED: { id: 'completed', label: 'Completed', icon: CheckCircle, color: 'bg-emerald-600', description: 'Successfully implemented' },
      DECLINED: { id: 'declined', label: 'Declined', icon: X, color: 'bg-red-500', description: 'Not moving forward' },
      ARCHIVED: { id: 'archived', label: 'Archived', icon: Archive, color: 'bg-gray-500', description: 'No longer active' }
    };

    const DECISION_TYPES = {
      APPROVED: 'approved',
      DECLINED: 'declined',
      NEEDS_REVISION: 'needs_revision',
      DEFERRED: 'deferred'
    };

    // ============================================================================
    // CONTEXT: Authentication (Firebase)
    // ============================================================================

    const AuthContext = createContext(null);
    const useAuth = () => useContext(AuthContext);

    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(true);

      // Listen to auth state changes
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
          if (firebaseUser) {
            // Get user profile from Firestore
            const profileDoc = await db.collection('users').doc(firebaseUser.uid).get();
            if (profileDoc.exists) {
              const profileData = profileDoc.data();

              // Auto-upgrade Katie to admin if not already set
              const isKatie = profileData.email?.toLowerCase() === 'katie@thesandwichproject.org';
              if (isKatie && (!profileData.isAdmin || profileData.approved === undefined)) {
                await db.collection('users').doc(firebaseUser.uid).update({
                  isAdmin: true,
                  approved: true
                });
                profileData.isAdmin = true;
                profileData.approved = true;
              }

              const profile = { id: firebaseUser.uid, ...profileData };
              setUser(profile);
              setUserProfile(profile);
            }
          } else {
            setUser(null);
            setUserProfile(null);
          }
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      // Listen to all users (for assignment dropdowns, etc.)
      useEffect(() => {
        const unsubscribe = db.collection('users').onSnapshot((snapshot) => {
          const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setUsers(usersData);
        });
        return () => unsubscribe();
      }, []);

      const register = async (name, email, password, role = 'team_member') => {
        try {
          const credential = await auth.createUserWithEmailAndPassword(email, password);
          // Katie is auto-approved and admin; all others need approval
          const isKatie = email.toLowerCase() === 'katie@thesandwichproject.org';
          await db.collection('users').doc(credential.user.uid).set({
            name,
            email,
            role,
            isAdmin: isKatie,
            approved: isKatie, // Only Katie is auto-approved
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          return { success: true };
        } catch (error) {
          return { error: error.message };
        }
      };

      const login = async (email, password) => {
        try {
          await auth.signInWithEmailAndPassword(email, password);
          return { success: true };
        } catch (error) {
          return { error: error.message };
        }
      };

      const logout = () => auth.signOut();

      const approveUser = async (userId) => {
        await db.collection('users').doc(userId).update({ approved: true });
      };

      const rejectUser = async (userId) => {
        // Delete the user document (they'll need to re-register if rejected)
        await db.collection('users').doc(userId).delete();
      };

      const pendingUsers = users.filter(u => u.approved === false);

      return (
        <AuthContext.Provider value={{ user, users, pendingUsers, loading, register, login, logout, approveUser, rejectUser }}>
          {children}
        </AuthContext.Provider>
      );
    };

    // ============================================================================
    // CONTEXT: Ideas Data (Firestore with Real-time)
    // ============================================================================

    const IdeasContext = createContext(null);
    const useIdeas = () => useContext(IdeasContext);

    const IdeasProvider = ({ children }) => {
      const [ideas, setIdeas] = useState([]);
      const [appeals, setAppeals] = useState([]);
      const [loading, setLoading] = useState(true);

      // Real-time listener for ideas
      useEffect(() => {
        const unsubscribe = db.collection('ideas')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            const ideasData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              createdAt: doc.data().createdAt?.toDate?.()?.toISOString() || new Date().toISOString(),
              updatedAt: doc.data().updatedAt?.toDate?.()?.toISOString() || new Date().toISOString(),
              feedbackDeadline: doc.data().feedbackDeadline?.toDate?.()?.toISOString(),
            }));
            setIdeas(ideasData);
            setLoading(false);
          });
        return () => unsubscribe();
      }, []);

      // Real-time listener for appeals
      useEffect(() => {
        const unsubscribe = db.collection('appeals')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            const appealsData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              createdAt: doc.data().createdAt?.toDate?.()?.toISOString() || new Date().toISOString(),
              reviewDeadline: doc.data().reviewDeadline?.toDate?.()?.toISOString(),
            }));
            setAppeals(appealsData);
          });
        return () => unsubscribe();
      }, []);

      const submitIdea = async (idea, userId, userName) => {
        const feedbackDeadline = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000);
        const docRef = await db.collection('ideas').add({
          ...idea,
          submitterId: userId,
          submitterName: userName,
          status: 'submitted',
          feedbackDeadline: firebase.firestore.Timestamp.fromDate(feedbackDeadline),
          seconds: [],
          comments: [],
          decision: null,
          owner: null,
          checkIns: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return docRef.id;
      };

      const updateIdea = async (ideaId, updates) => {
        await db.collection('ideas').doc(ideaId).update({
          ...updates,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      };

      const addSecond = async (ideaId, userId, userName) => {
        const ideaRef = db.collection('ideas').doc(ideaId);
        const ideaDoc = await ideaRef.get();
        const idea = ideaDoc.data();

        if (idea.seconds?.find(s => s.userId === userId)) return;

        const newSecond = { userId, userName, timestamp: new Date().toISOString() };
        const newSeconds = [...(idea.seconds || []), newSecond];

        const updates = { seconds: newSeconds };
        if (newSeconds.length >= 2 && idea.status === 'submitted') {
          updates.status = 'seconded';
        }

        await updateIdea(ideaId, updates);
      };

      const addComment = async (ideaId, userId, userName, text) => {
        const ideaRef = db.collection('ideas').doc(ideaId);
        const ideaDoc = await ideaRef.get();
        const idea = ideaDoc.data();

        const newComment = {
          id: Date.now().toString(),
          userId,
          userName,
          text,
          timestamp: new Date().toISOString()
        };

        await updateIdea(ideaId, { comments: [...(idea.comments || []), newComment] });
      };

      const makeDecision = async (ideaId, decision, rationale, deciderId, deciderName) => {
        const newStatus = decision === DECISION_TYPES.APPROVED ? 'in_progress' : 'declined';
        const appealDeadline = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000);

        await updateIdea(ideaId, {
          status: newStatus,
          decision: {
            type: decision,
            rationale,
            deciderId,
            deciderName,
            timestamp: new Date().toISOString(),
            appealDeadline: appealDeadline.toISOString()
          }
        });
      };

      const submitAppeal = async (ideaId, userId, userName, reason, preferredOutcome) => {
        const reviewDeadline = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
        await db.collection('appeals').add({
          ideaId,
          submitterId: userId,
          submitterName: userName,
          reason,
          preferredOutcome,
          status: 'pending',
          votes: [],
          reviewDeadline: firebase.firestore.Timestamp.fromDate(reviewDeadline),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      };

      const voteOnAppeal = async (appealId, userId, userName, vote) => {
        const appealRef = db.collection('appeals').doc(appealId);
        const appealDoc = await appealRef.get();
        const appeal = appealDoc.data();

        let newVotes = [...(appeal.votes || [])];
        const existingIndex = newVotes.findIndex(v => v.userId === userId);

        if (existingIndex >= 0) {
          newVotes[existingIndex] = { userId, userName, vote, timestamp: new Date().toISOString() };
        } else {
          newVotes.push({ userId, userName, vote, timestamp: new Date().toISOString() });
        }

        await appealRef.update({ votes: newVotes });
      };

      const resolveAppeal = async (appealId, outcome) => {
        const appealRef = db.collection('appeals').doc(appealId);
        const appealDoc = await appealRef.get();
        const appeal = appealDoc.data();

        await appealRef.update({ status: outcome });

        if (outcome === 'upheld') {
          await updateIdea(appeal.ideaId, { status: 'seconded', decision: null });
        }
      };

      const assignOwner = async (ideaId, ownerId, ownerName) => {
        await updateIdea(ideaId, { owner: { id: ownerId, name: ownerName } });
      };

      const addCheckIn = async (ideaId, userId, userName, note, progress) => {
        const ideaRef = db.collection('ideas').doc(ideaId);
        const ideaDoc = await ideaRef.get();
        const idea = ideaDoc.data();

        const newCheckIn = {
          id: Date.now().toString(),
          userId,
          userName,
          note,
          progress,
          timestamp: new Date().toISOString()
        };

        await updateIdea(ideaId, { checkIns: [...(idea.checkIns || []), newCheckIn] });
      };

      const completeIdea = async (ideaId) => {
        await updateIdea(ideaId, { status: 'completed', completedAt: new Date().toISOString() });
      };

      return (
        <IdeasContext.Provider value={{
          ideas, appeals, loading, submitIdea, updateIdea, addSecond, addComment,
          makeDecision, submitAppeal, voteOnAppeal, resolveAppeal,
          assignOwner, addCheckIn, completeIdea
        }}>
          {children}
        </IdeasContext.Provider>
      );
    };

    // ============================================================================
    // COMPONENTS: Auth
    // ============================================================================

    const AuthForm = () => {
      const [isLogin, setIsLogin] = useState(true);
      const [formData, setFormData] = useState({ name: '', email: '', password: '', role: 'team_member' });
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const { login, register } = useAuth();

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (isLogin) {
          const result = await login(formData.email, formData.password);
          if (result.error) setError(result.error);
        } else {
          if (!formData.name.trim()) {
            setError('Name is required');
            setLoading(false);
            return;
          }
          const result = await register(formData.name, formData.email, formData.password, formData.role);
          if (result.error) setError(result.error);
        }
        setLoading(false);
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'linear-gradient(135deg, #e8f4f8 0%, #d4eef3 100%)' }}>
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={{ backgroundColor: '#236383' }}>
                <span className="text-3xl">ü•™</span>
              </div>
              <h1 className="text-2xl font-bold text-gray-800">The Sandwich Project</h1>
              <p className="text-gray-600 mt-2">Idea & Decision Hub</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              {!isLogin && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                      style={{ '--tw-ring-color': '#47b3cb' }}
                      placeholder="Your full name"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select
                      value={formData.role}
                      onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                    >
                      <option value="team_member">Team Member</option>
                      <option value="core_team">Core Team</option>
                      <option value="ed">Executive Director</option>
                    </select>
                  </div>
                  <p className="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                    ‚ìò New accounts require admin approval before you can access the Ideas Hub.
                  </p>
                </>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                  placeholder="you@example.com"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input
                  type="password"
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                  minLength={6}
                />
              </div>

              {error && (
                <div className="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                style={{ backgroundColor: loading ? '#5a9aad' : '#007e8c' }}
                onMouseOver={(e) => !loading && (e.target.style.backgroundColor = '#006674')}
                onMouseOut={(e) => !loading && (e.target.style.backgroundColor = '#007e8c')}
              >
                {loading && <Loader2 className="animate-spin" size={18} />}
                {isLogin ? 'Sign In' : 'Create Account'}
              </button>
            </form>

            <p className="text-center text-gray-600 mt-6">
              {isLogin ? "Don't have an account?" : 'Already have an account?'}
              <button
                onClick={() => setIsLogin(!isLogin)}
                className="font-semibold ml-2 hover:underline"
                style={{ color: '#007e8c' }}
              >
                {isLogin ? 'Sign up' : 'Sign in'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    // ============================================================================
    // COMPONENTS: Sidebar
    // ============================================================================

    // Shield icon for admin
    const Shield = ({ size, className }) => <Icon size={size} className={className} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM12 8v4M12 16h.01" />;

    const Sidebar = ({ currentView, setCurrentView }) => {
      const { user, logout, pendingUsers } = useAuth();
      const { ideas, appeals } = useIdeas();

      const pendingAppeals = appeals.filter(a => a.status === 'pending').length;
      const inFeedback = ideas.filter(i => i.status === 'submitted').length;
      const readyForReview = ideas.filter(i => i.status === 'seconded').length;
      const pendingUserCount = pendingUsers?.length || 0;

      const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: Home },
        { id: 'submit', label: 'Submit Idea', icon: Plus },
        { id: 'feedback', label: 'Feedback Queue', icon: MessageSquare, badge: inFeedback },
        { id: 'review', label: 'Review Queue', icon: Vote, badge: readyForReview },
        { id: 'active', label: 'Active Ideas', icon: Play },
        { id: 'appeals', label: 'Appeals', icon: Gavel, badge: pendingAppeals },
        { id: 'archive', label: 'Archive', icon: Archive }
      ];

      // Admin-only nav items
      if (user?.isAdmin) {
        navItems.push({ id: 'admin', label: 'User Approvals', icon: Shield, badge: pendingUserCount });
      }

      return (
        <div className="w-64 bg-white min-h-screen flex flex-col border-r border-gray-200">
          <div className="p-4 border-b border-gray-200" style={{ backgroundColor: '#236383' }}>
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                <span className="text-xl">ü•™</span>
              </div>
              <div>
                <h1 className="text-white font-bold">TSP Ideas</h1>
                <p className="text-white/70 text-xs">Decision Hub</p>
              </div>
            </div>
          </div>

          <nav className="flex-1 p-4">
            <ul className="space-y-1">
              {navItems.map(item => (
                <li key={item.id}>
                  <button
                    onClick={() => setCurrentView(item.id)}
                    className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${
                      currentView === item.id
                        ? 'text-white'
                        : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                    }`}
                    style={currentView === item.id ? { backgroundColor: '#007e8c' } : {}}
                  >
                    <item.icon size={18} />
                    <span className="flex-1 text-left">{item.label}</span>
                    {item.badge > 0 && (
                      <span className="text-white text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: '#a31c41' }}>
                        {item.badge}
                      </span>
                    )}
                  </button>
                </li>
              ))}
            </ul>
          </nav>

          <div className="p-4 border-t border-gray-200">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: '#47b3cb' }}>
                <User size={16} className="text-white" />
              </div>
              <div className="flex-1 min-w-0">
                <p className="text-gray-800 text-sm font-medium truncate">{user?.name}</p>
                <p className="text-gray-500 text-xs capitalize">
                  {user?.isAdmin ? 'Admin' : user?.role?.replace('_', ' ')}
                </p>
              </div>
            </div>
            <button
              onClick={logout}
              className="w-full flex items-center gap-2 px-3 py-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <LogOut size={16} />
              <span>Sign Out</span>
            </button>
          </div>
        </div>
      );
    };

    // ============================================================================
    // COMPONENTS: Dashboard
    // ============================================================================

    const Dashboard = ({ setCurrentView, setSelectedIdea }) => {
      const { ideas } = useIdeas();

      const stats = {
        total: ideas.length,
        inProgress: ideas.filter(i => i.status === 'in_progress').length,
        completed: ideas.filter(i => i.status === 'completed').length,
        awaitingFeedback: ideas.filter(i => i.status === 'submitted').length,
        seconded: ideas.filter(i => i.status === 'seconded').length
      };

      const recentIdeas = [...ideas].slice(0, 5);

      return (
        <div className="p-6">
          <div className="mb-8">
            <h1 className="text-2xl font-bold text-gray-800">Dashboard</h1>
            <p className="text-gray-600">Overview of all ideas and their progress</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <FileText className="text-blue-600" size={20} />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-800">{stats.total}</p>
                  <p className="text-gray-500 text-sm">Total Ideas</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <MessageSquare className="text-purple-600" size={20} />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-800">{stats.awaitingFeedback}</p>
                  <p className="text-gray-500 text-sm">Awaiting Feedback</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <ThumbsUp className="text-indigo-600" size={20} />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-800">{stats.seconded}</p>
                  <p className="text-gray-500 text-sm">Seconded</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <Play className="text-green-600" size={20} />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-800">{stats.inProgress}</p>
                  <p className="text-gray-500 text-sm">In Progress</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                  <CheckCircle className="text-emerald-600" size={20} />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-800">{stats.completed}</p>
                  <p className="text-gray-500 text-sm">Completed</p>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
            <h2 className="text-lg font-semibold text-gray-800 mb-4">Workflow Pipeline</h2>
            <div className="flex items-center gap-2 overflow-x-auto pb-2">
              {Object.values(WORKFLOW_STAGES).slice(0, 7).map((stage, idx) => {
                const count = ideas.filter(i => i.status === stage.id).length;
                const Icon = stage.icon;
                return (
                  <Fragment key={stage.id}>
                    <div className="flex-shrink-0 flex flex-col items-center gap-2 min-w-[100px]">
                      <div className={`w-12 h-12 ${stage.color} rounded-full flex items-center justify-center text-white`}>
                        <Icon size={20} />
                      </div>
                      <div className="text-center">
                        <p className="text-xs font-medium text-gray-800">{stage.label}</p>
                        <p className="text-lg font-bold text-gray-800">{count}</p>
                      </div>
                    </div>
                    {idx < 6 && <ChevronRight className="text-gray-300 flex-shrink-0" />}
                  </Fragment>
                );
              })}
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold text-gray-800">Recent Ideas</h2>
              <button onClick={() => setCurrentView('submit')} className="flex items-center gap-2 text-amber-600 hover:text-amber-700 font-medium">
                <Plus size={18} /> Submit New
              </button>
            </div>

            {recentIdeas.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No ideas yet. Be the first to submit one!</p>
            ) : (
              <div className="space-y-3">
                {recentIdeas.map(idea => {
                  const stage = WORKFLOW_STAGES[idea.status.toUpperCase()] || WORKFLOW_STAGES.SUBMITTED;
                  return (
                    <div key={idea.id} onClick={() => { setSelectedIdea(idea); setCurrentView('detail'); }} className="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                      <div className={`w-2 h-2 rounded-full ${stage.color}`} />
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-gray-800 truncate">{idea.title}</p>
                        <p className="text-sm text-gray-500">by {idea.submitterName}</p>
                      </div>
                      <div className="flex items-center gap-2 text-sm text-gray-500">
                        <ThumbsUp size={14} /><span>{idea.seconds?.length || 0}</span>
                        <MessageSquare size={14} className="ml-2" /><span>{idea.comments?.length || 0}</span>
                      </div>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium text-white ${stage.color}`}>{stage.label}</span>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================================
    // COMPONENTS: Idea Submission Form
    // ============================================================================

    const IdeaSubmissionForm = ({ setCurrentView }) => {
      const { user } = useAuth();
      const { submitIdea } = useIdeas();
      const [formData, setFormData] = useState({ title: '', description: '', whyItMatters: '', whoNeeded: '', resources: '', timeline: '', risks: '', missionAlignment: '' });
      const [submitted, setSubmitted] = useState(false);
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await submitIdea(formData, user.id, user.name);
        setLoading(false);
        setSubmitted(true);
        setTimeout(() => setCurrentView('dashboard'), 2000);
      };

      if (submitted) {
        return (
          <div className="p-6 flex items-center justify-center min-h-[60vh]">
            <div className="text-center">
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="text-green-600" size={40} />
              </div>
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Idea Submitted!</h2>
              <p className="text-gray-600">Your idea is now in the feedback queue.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="p-6 max-w-3xl mx-auto">
          <div className="mb-8">
            <h1 className="text-2xl font-bold text-gray-800">Submit an Idea</h1>
            <p className="text-gray-600">Share your idea with the team. Ideas with 2+ seconds advance to review.</p>
          </div>

          <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Title <span className="text-red-500">*</span></label>
              <input type="text" value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Brief, descriptive title" required />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Description <span className="text-red-500">*</span></label>
              <textarea value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" rows={4} placeholder="Detailed explanation of your idea" required />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Why It Matters <span className="text-red-500">*</span></label>
              <textarea value={formData.whyItMatters} onChange={(e) => setFormData({ ...formData, whyItMatters: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" rows={3} placeholder="How does this help TSP's mission?" required />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Who's Needed</label>
                <input type="text" value={formData.whoNeeded} onChange={(e) => setFormData({ ...formData, whoNeeded: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="e.g., 2 volunteers, marketing team" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Resources Required</label>
                <input type="text" value={formData.resources} onChange={(e) => setFormData({ ...formData, resources: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="e.g., $500 budget, new software" />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Timeline</label>
                <input type="text" value={formData.timeline} onChange={(e) => setFormData({ ...formData, timeline: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="e.g., 2 weeks, Q2 2026" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Risks/Concerns</label>
                <input type="text" value={formData.risks} onChange={(e) => setFormData({ ...formData, risks: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Potential challenges or downsides" />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Mission Alignment</label>
              <textarea value={formData.missionAlignment} onChange={(e) => setFormData({ ...formData, missionAlignment: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" rows={2} placeholder="How does this align with TSP's core mission?" />
            </div>

            <div className="flex gap-4 pt-4">
              <button type="button" onClick={() => setCurrentView('dashboard')} className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button type="submit" disabled={loading} className="flex-1 bg-amber-500 hover:bg-amber-600 disabled:bg-amber-300 text-white font-semibold py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                {loading && <Loader2 className="animate-spin" size={18} />} Submit Idea
              </button>
            </div>
          </form>
        </div>
      );
    };

    // ============================================================================
    // COMPONENTS: Idea Detail View (Condensed)
    // ============================================================================

    const IdeaDetail = ({ idea, setCurrentView, setSelectedIdea }) => {
      const { user, users } = useAuth();
      const { addSecond, addComment, makeDecision, assignOwner, addCheckIn, completeIdea, submitAppeal, appeals } = useIdeas();
      const [comment, setComment] = useState('');
      const [showDecisionModal, setShowDecisionModal] = useState(false);
      const [showAppealModal, setShowAppealModal] = useState(false);
      const [showAssignModal, setShowAssignModal] = useState(false);
      const [checkInNote, setCheckInNote] = useState('');
      const [checkInProgress, setCheckInProgress] = useState(50);
      const [actionLoading, setActionLoading] = useState(false);

      if (!idea) return null;

      const stage = WORKFLOW_STAGES[idea.status.toUpperCase()] || WORKFLOW_STAGES.SUBMITTED;
      const hasSeconded = idea.seconds?.some(s => s.userId === user.id);
      const isSubmitter = idea.submitterId === user.id;
      const isED = user.role === 'ed';
      const isCoreTeam = user.role === 'core_team' || isED;
      const canAppeal = idea.decision && new Date(idea.decision.appealDeadline) > new Date();
      const existingAppeal = appeals.find(a => a.ideaId === idea.id && a.status === 'pending');

      const handleAddComment = async (e) => { e.preventDefault(); if (!comment.trim()) return; await addComment(idea.id, user.id, user.name, comment); setComment(''); };
      const handleSecond = async () => { setActionLoading(true); await addSecond(idea.id, user.id, user.name); setActionLoading(false); };
      const handleAddCheckIn = async (e) => { e.preventDefault(); if (!checkInNote.trim()) return; await addCheckIn(idea.id, user.id, user.name, checkInNote, checkInProgress); setCheckInNote(''); };

      return (
        <div className="p-6 max-w-4xl mx-auto">
          <button onClick={() => { setSelectedIdea(null); setCurrentView('dashboard'); }} className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-6">‚Üê Back</button>

          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <span className={`inline-block px-3 py-1 rounded-full text-sm font-medium text-white ${stage.color} mb-2`}>{stage.label}</span>
                <h1 className="text-2xl font-bold text-gray-800">{idea.title}</h1>
                <p className="text-gray-500 mt-1">Submitted by {idea.submitterName} on {new Date(idea.createdAt).toLocaleDateString()}</p>
              </div>
              <span className="flex items-center gap-1 text-gray-500"><ThumbsUp size={16} /> {idea.seconds?.length || 0} seconds</span>
            </div>

            <div className="flex flex-wrap gap-3 pt-4 border-t">
              {(idea.status === 'submitted' || idea.status === 'feedback') && !hasSeconded && !isSubmitter && (
                <button onClick={handleSecond} disabled={actionLoading} className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:bg-indigo-300 transition-colors">
                  {actionLoading ? <Loader2 className="animate-spin" size={16} /> : <ThumbsUp size={16} />} Second This Idea
                </button>
              )}
              {hasSeconded && <span className="flex items-center gap-2 px-4 py-2 bg-indigo-100 text-indigo-600 rounded-lg"><CheckCircle size={16} /> You seconded this</span>}
              {idea.status === 'seconded' && isCoreTeam && <button onClick={() => setShowDecisionModal(true)} className="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600"><Gavel size={16} /> Make Decision</button>}
              {idea.status === 'in_progress' && isCoreTeam && !idea.owner && <button onClick={() => setShowAssignModal(true)} className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><User size={16} /> Assign Owner</button>}
              {idea.status === 'in_progress' && (idea.owner?.id === user.id || isCoreTeam) && <button onClick={() => completeIdea(idea.id)} className="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600"><CheckCircle size={16} /> Mark Complete</button>}
              {canAppeal && !existingAppeal && <button onClick={() => setShowAppealModal(true)} className="flex items-center gap-2 px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50"><AlertTriangle size={16} /> Appeal Decision</button>}
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6"><h2 className="font-semibold text-gray-800 mb-3">Description</h2><p className="text-gray-600 whitespace-pre-wrap">{idea.description}</p></div>
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6"><h2 className="font-semibold text-gray-800 mb-3">Why It Matters</h2><p className="text-gray-600 whitespace-pre-wrap">{idea.whyItMatters}</p></div>

              {idea.decision && (
                <div className={`rounded-xl p-6 ${idea.decision.type === 'approved' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                  <h2 className="font-semibold text-gray-800 mb-3 flex items-center gap-2"><Gavel size={18} /> Decision: {idea.decision.type.replace('_', ' ').toUpperCase()}</h2>
                  <p className="text-gray-600 mb-2">{idea.decision.rationale}</p>
                  <p className="text-sm text-gray-500">By {idea.decision.deciderName} on {new Date(idea.decision.timestamp).toLocaleDateString()}</p>
                  {canAppeal && <p className="text-sm text-amber-600 mt-2">Appeal deadline: {new Date(idea.decision.appealDeadline).toLocaleDateString()}</p>}
                </div>
              )}

              {idea.status === 'in_progress' && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                  <h2 className="font-semibold text-gray-800 mb-4">Progress Check-ins</h2>
                  {(idea.owner?.id === user.id || isCoreTeam) && (
                    <form onSubmit={handleAddCheckIn} className="mb-4 p-4 bg-gray-50 rounded-lg">
                      <div className="mb-3"><label className="block text-sm font-medium text-gray-700 mb-1">Progress: {checkInProgress}%</label><input type="range" min="0" max="100" value={checkInProgress} onChange={(e) => setCheckInProgress(Number(e.target.value))} className="w-full" /></div>
                      <textarea value={checkInNote} onChange={(e) => setCheckInNote(e.target.value)} placeholder="What's the latest update?" className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2" rows={2} />
                      <button type="submit" className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Add Check-in</button>
                    </form>
                  )}
                  <div className="space-y-3">
                    {(idea.checkIns || []).map(checkIn => (
                      <div key={checkIn.id} className="p-3 bg-gray-50 rounded-lg">
                        <div className="flex items-center justify-between mb-2"><span className="font-medium text-gray-800">{checkIn.userName}</span><span className="text-sm text-gray-500">{new Date(checkIn.timestamp).toLocaleDateString()}</span></div>
                        <div className="w-full bg-gray-200 rounded-full h-2 mb-2"><div className="bg-green-500 h-2 rounded-full" style={{ width: `${checkIn.progress}%` }} /></div>
                        <p className="text-gray-600">{checkIn.note}</p>
                      </div>
                    ))}
                    {(!idea.checkIns || idea.checkIns.length === 0) && <p className="text-gray-500 text-center py-4">No check-ins yet</p>}
                  </div>
                </div>
              )}

              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 className="font-semibold text-gray-800 mb-4">Comments ({idea.comments?.length || 0})</h2>
                <form onSubmit={handleAddComment} className="mb-4">
                  <div className="flex gap-2">
                    <input type="text" value={comment} onChange={(e) => setComment(e.target.value)} placeholder="Add a comment..." className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
                    <button type="submit" className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors"><Send size={18} /></button>
                  </div>
                </form>
                <div className="space-y-3">
                  {(idea.comments || []).map(c => (
                    <div key={c.id} className="p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center justify-between mb-1"><span className="font-medium text-gray-800">{c.userName}</span><span className="text-xs text-gray-500">{new Date(c.timestamp).toLocaleString()}</span></div>
                      <p className="text-gray-600">{c.text}</p>
                    </div>
                  ))}
                  {(!idea.comments || idea.comments.length === 0) && <p className="text-gray-500 text-center py-4">No comments yet. Be the first!</p>}
                </div>
              </div>
            </div>

            <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 className="font-semibold text-gray-800 mb-4">Details</h3>
                <div className="space-y-3 text-sm">
                  {idea.whoNeeded && <div><span className="text-gray-500">Who's Needed:</span><p className="text-gray-800">{idea.whoNeeded}</p></div>}
                  {idea.resources && <div><span className="text-gray-500">Resources:</span><p className="text-gray-800">{idea.resources}</p></div>}
                  {idea.timeline && <div><span className="text-gray-500">Timeline:</span><p className="text-gray-800">{idea.timeline}</p></div>}
                  {idea.risks && <div><span className="text-gray-500">Risks:</span><p className="text-gray-800">{idea.risks}</p></div>}
                </div>
              </div>
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 className="font-semibold text-gray-800 mb-4">Seconds ({idea.seconds?.length || 0}/2 needed)</h3>
                <div className="space-y-2">
                  {(idea.seconds || []).map(s => <div key={s.userId} className="flex items-center gap-2 text-sm"><ThumbsUp size={14} className="text-indigo-500" /><span>{s.userName}</span></div>)}
                  {(!idea.seconds || idea.seconds.length === 0) && <p className="text-gray-500 text-sm">No seconds yet</p>}
                </div>
              </div>
              {idea.owner && <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6"><h3 className="font-semibold text-gray-800 mb-3">Owner</h3><div className="flex items-center gap-2"><div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><User size={16} className="text-green-600" /></div><span className="font-medium text-gray-800">{idea.owner.name}</span></div></div>}
              {(idea.status === 'submitted' || idea.status === 'feedback') && idea.feedbackDeadline && <div className="bg-amber-50 border border-amber-200 rounded-xl p-4"><div className="flex items-center gap-2 text-amber-700"><Clock size={18} /><span className="font-medium">Feedback Deadline</span></div><p className="text-amber-600 mt-1">{new Date(idea.feedbackDeadline).toLocaleDateString()}</p></div>}
            </div>
          </div>

          {showDecisionModal && <DecisionModal idea={idea} onClose={() => setShowDecisionModal(false)} onDecision={async (decision, rationale) => { await makeDecision(idea.id, decision, rationale, user.id, user.name); setShowDecisionModal(false); }} />}
          {showAppealModal && <AppealModal idea={idea} onClose={() => setShowAppealModal(false)} onSubmit={async (reason, preferredOutcome) => { await submitAppeal(idea.id, user.id, user.name, reason, preferredOutcome); setShowAppealModal(false); }} />}
          {showAssignModal && <AssignOwnerModal users={users} onClose={() => setShowAssignModal(false)} onAssign={async (ownerId, ownerName) => { await assignOwner(idea.id, ownerId, ownerName); setShowAssignModal(false); }} />}
        </div>
      );
    };

    // ============================================================================
    // MODALS
    // ============================================================================

    const DecisionModal = ({ idea, onClose, onDecision }) => {
      const [decision, setDecision] = useState('approved');
      const [rationale, setRationale] = useState('');
      const [loading, setLoading] = useState(false);
      const handleSubmit = async () => { setLoading(true); await onDecision(decision, rationale); setLoading(false); };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-lg w-full p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Make Decision</h2>
            <p className="text-gray-600 mb-4">Decide on: <strong>{idea.title}</strong></p>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Decision</label>
              <div className="space-y-2">
                {Object.entries(DECISION_TYPES).map(([key, value]) => <label key={key} className="flex items-center gap-2"><input type="radio" value={value} checked={decision === value} onChange={(e) => setDecision(e.target.value)} className="text-amber-500 focus:ring-amber-500" /><span className="capitalize">{value.replace('_', ' ')}</span></label>)}
              </div>
            </div>
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-1">Rationale <span className="text-red-500">*</span></label>
              <textarea value={rationale} onChange={(e) => setRationale(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg" rows={4} placeholder="Explain your decision (required for transparency)" />
            </div>
            <div className="flex gap-3">
              <button onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancel</button>
              <button onClick={handleSubmit} disabled={!rationale.trim() || loading} className="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:bg-amber-300 flex items-center justify-center gap-2">{loading && <Loader2 className="animate-spin" size={16} />} Submit Decision</button>
            </div>
          </div>
        </div>
      );
    };

    const AppealModal = ({ idea, onClose, onSubmit }) => {
      const [reason, setReason] = useState('');
      const [preferredOutcome, setPreferredOutcome] = useState('');
      const [loading, setLoading] = useState(false);
      const handleSubmit = async () => { setLoading(true); await onSubmit(reason, preferredOutcome); setLoading(false); };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-lg w-full p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Appeal Decision</h2>
            <div className="mb-4"><label className="block text-sm font-medium text-gray-700 mb-1">Why do you disagree?</label><textarea value={reason} onChange={(e) => setReason(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg" rows={4} /></div>
            <div className="mb-6"><label className="block text-sm font-medium text-gray-700 mb-1">Preferred Outcome</label><textarea value={preferredOutcome} onChange={(e) => setPreferredOutcome(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg" rows={2} /></div>
            <div className="flex gap-3">
              <button onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg">Cancel</button>
              <button onClick={handleSubmit} disabled={!reason.trim() || !preferredOutcome.trim() || loading} className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg disabled:bg-red-300 flex items-center justify-center gap-2">{loading && <Loader2 className="animate-spin" size={16} />} Submit Appeal</button>
            </div>
          </div>
        </div>
      );
    };

    const AssignOwnerModal = ({ users, onClose, onAssign }) => {
      const [selectedUser, setSelectedUser] = useState('');
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-md w-full p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Assign Owner</h2>
            <select value={selectedUser} onChange={(e) => setSelectedUser(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-6">
              <option value="">Choose...</option>
              {users.map(u => <option key={u.id} value={u.id}>{u.name} ({u.role})</option>)}
            </select>
            <div className="flex gap-3">
              <button onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg">Cancel</button>
              <button onClick={() => { const user = users.find(u => u.id === selectedUser); if (user) onAssign(user.id, user.name); }} disabled={!selectedUser} className="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg disabled:bg-green-300">Assign</button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // LIST VIEWS
    // ============================================================================

    const IdeaList = ({ ideas, title, subtitle, emptyMessage, setSelectedIdea, setCurrentView }) => (
      <div className="p-6">
        <div className="mb-6"><h1 className="text-2xl font-bold text-gray-800">{title}</h1><p className="text-gray-600">{subtitle}</p></div>
        {ideas.length === 0 ? <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center"><p className="text-gray-500">{emptyMessage}</p></div> : (
          <div className="grid gap-4">
            {ideas.map(idea => {
              const stage = WORKFLOW_STAGES[idea.status.toUpperCase()] || WORKFLOW_STAGES.SUBMITTED;
              return (
                <div key={idea.id} onClick={() => { setSelectedIdea(idea); setCurrentView('detail'); }} className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md cursor-pointer transition-shadow">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <span className={`px-2 py-1 rounded-full text-xs font-medium text-white ${stage.color}`}>{stage.label}</span>
                        {idea.seconds?.length >= 2 && <span className="px-2 py-1 bg-indigo-100 text-indigo-600 rounded-full text-xs font-medium">‚úì Seconded</span>}
                      </div>
                      <h3 className="font-semibold text-gray-800 mb-1">{idea.title}</h3>
                      <p className="text-gray-600 text-sm line-clamp-2">{idea.description}</p>
                      <p className="text-gray-500 text-xs mt-2">by {idea.submitterName}</p>
                    </div>
                    <div className="flex items-center gap-3 text-sm text-gray-500 ml-4">
                      <span className="flex items-center gap-1"><ThumbsUp size={14} />{idea.seconds?.length || 0}</span>
                      <span className="flex items-center gap-1"><MessageSquare size={14} />{idea.comments?.length || 0}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    );

    const FeedbackQueue = (props) => { const { ideas } = useIdeas(); return <IdeaList ideas={ideas.filter(i => i.status === 'submitted')} title="Feedback Queue" subtitle="Ideas awaiting team input" emptyMessage="No ideas awaiting feedback" {...props} />; };
    const ReviewQueue = (props) => { const { ideas } = useIdeas(); return <IdeaList ideas={ideas.filter(i => i.status === 'seconded')} title="Review Queue" subtitle="Ideas ready for decision" emptyMessage="No ideas in review" {...props} />; };
    const ActiveIdeas = (props) => { const { ideas } = useIdeas(); return <IdeaList ideas={ideas.filter(i => i.status === 'in_progress')} title="Active Ideas" subtitle="Currently being implemented" emptyMessage="No active ideas" {...props} />; };
    const ArchiveView = (props) => { const { ideas } = useIdeas(); return <IdeaList ideas={ideas.filter(i => ['completed', 'declined', 'archived'].includes(i.status))} title="Archive" subtitle="Completed and declined ideas" emptyMessage="No archived ideas" {...props} />; };

    const AppealsView = () => {
      const { user } = useAuth();
      const { ideas, appeals, voteOnAppeal, resolveAppeal } = useIdeas();
      const isCoreTeam = user.role === 'core_team' || user.role === 'ed';
      const pendingAppeals = appeals.filter(a => a.status === 'pending');

      return (
        <div className="p-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-6">Appeals</h1>
          {pendingAppeals.length === 0 ? <div className="bg-white rounded-xl p-12 text-center"><p className="text-gray-500">No pending appeals</p></div> : (
            <div className="space-y-4">
              {pendingAppeals.map(appeal => {
                const idea = ideas.find(i => i.id === appeal.ideaId);
                const userVote = appeal.votes?.find(v => v.userId === user.id);
                return (
                  <div key={appeal.id} className="bg-white rounded-xl p-6 shadow-sm">
                    <h3 className="font-semibold text-gray-800 mb-2">{idea?.title}</h3>
                    <p className="text-gray-600 mb-4">{appeal.reason}</p>
                    {isCoreTeam && appeal.submitterId !== user.id && (
                      <div className="flex gap-2">
                        <button onClick={() => voteOnAppeal(appeal.id, user.id, user.name, 'uphold')} className={`px-4 py-2 rounded-lg ${userVote?.vote === 'uphold' ? 'bg-green-500 text-white' : 'border border-green-500 text-green-500'}`}>Uphold</button>
                        <button onClick={() => voteOnAppeal(appeal.id, user.id, user.name, 'deny')} className={`px-4 py-2 rounded-lg ${userVote?.vote === 'deny' ? 'bg-red-500 text-white' : 'border border-red-500 text-red-500'}`}>Deny</button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // Admin view for approving/rejecting users
    const AdminApprovalView = () => {
      const { pendingUsers, approveUser, rejectUser, users } = useAuth();
      const [actionLoading, setActionLoading] = useState(null);

      const handleApprove = async (userId) => {
        setActionLoading(userId);
        await approveUser(userId);
        setActionLoading(null);
      };

      const handleReject = async (userId) => {
        if (!confirm('Are you sure you want to reject this user? They will need to register again.')) return;
        setActionLoading(userId);
        await rejectUser(userId);
        setActionLoading(null);
      };

      const approvedUsers = users.filter(u => u.approved !== false);

      return (
        <div className="p-6">
          <div className="mb-8">
            <h1 className="text-2xl font-bold text-gray-800">User Management</h1>
            <p className="text-gray-600">Approve or reject new user registrations</p>
          </div>

          <div className="mb-8">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <Clock size={20} style={{ color: '#fbad3f' }} />
              Pending Approval ({pendingUsers.length})
            </h2>
            {pendingUsers.length === 0 ? (
              <div className="bg-white rounded-xl p-8 text-center border border-gray-100">
                <CheckCircle size={40} className="mx-auto mb-3 text-green-500" />
                <p className="text-gray-500">No pending users to approve</p>
              </div>
            ) : (
              <div className="space-y-3">
                {pendingUsers.map(u => (
                  <div key={u.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: '#47b3cb' }}>
                        <User size={20} className="text-white" />
                      </div>
                      <div>
                        <p className="font-medium text-gray-800">{u.name}</p>
                        <p className="text-sm text-gray-500">{u.email}</p>
                        <p className="text-xs text-gray-400 capitalize">Requested: {u.role?.replace('_', ' ')}</p>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleApprove(u.id)}
                        disabled={actionLoading === u.id}
                        className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-green-300 flex items-center gap-2"
                      >
                        {actionLoading === u.id ? <Loader2 className="animate-spin" size={16} /> : <CheckCircle size={16} />}
                        Approve
                      </button>
                      <button
                        onClick={() => handleReject(u.id)}
                        disabled={actionLoading === u.id}
                        className="px-4 py-2 border text-white rounded-lg hover:opacity-80 disabled:opacity-50"
                        style={{ backgroundColor: '#a31c41' }}
                      >
                        Reject
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div>
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <Users size={20} style={{ color: '#007e8c' }} />
              Active Users ({approvedUsers.length})
            </h2>
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="text-left px-4 py-3 text-sm font-medium text-gray-600">Name</th>
                    <th className="text-left px-4 py-3 text-sm font-medium text-gray-600">Email</th>
                    <th className="text-left px-4 py-3 text-sm font-medium text-gray-600">Role</th>
                    <th className="text-left px-4 py-3 text-sm font-medium text-gray-600">Status</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {approvedUsers.map(u => (
                    <tr key={u.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 text-gray-800">{u.name}</td>
                      <td className="px-4 py-3 text-gray-600">{u.email}</td>
                      <td className="px-4 py-3 text-gray-600 capitalize">{u.role?.replace('_', ' ')}</td>
                      <td className="px-4 py-3">
                        {u.isAdmin && (
                          <span className="px-2 py-1 rounded-full text-xs font-medium text-white" style={{ backgroundColor: '#236383' }}>
                            Admin
                          </span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    // Pending approval screen for non-approved users
    const PendingApprovalScreen = () => {
      const { logout, user } = useAuth();
      return (
        <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
            <div className="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style={{ backgroundColor: '#fbad3f' }}>
              <Clock size={40} className="text-white" />
            </div>
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Account Pending Approval</h1>
            <p className="text-gray-600 mb-6">
              Thanks for signing up, {user?.name}! Your account is awaiting approval from an administrator. You'll be able to access the Ideas Hub once approved.
            </p>
            <button
              onClick={logout}
              className="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <LogOut size={18} />
              Sign Out
            </button>
          </div>
        </div>
      );
    };

    // ============================================================================
    // MAIN APP
    // ============================================================================

    const MainApp = () => {
      const [currentView, setCurrentView] = useState('dashboard');
      const [selectedIdea, setSelectedIdea] = useState(null);
      const { ideas, loading } = useIdeas();

      useEffect(() => { if (selectedIdea) { const updated = ideas.find(i => i.id === selectedIdea.id); if (updated) setSelectedIdea(updated); } }, [ideas]);

      if (loading) return <div className="flex min-h-screen bg-gray-50 items-center justify-center"><Loader2 className="animate-spin text-amber-500" size={40} /></div>;

      const views = {
        dashboard: <Dashboard setCurrentView={setCurrentView} setSelectedIdea={setSelectedIdea} />,
        submit: <IdeaSubmissionForm setCurrentView={setCurrentView} />,
        feedback: <FeedbackQueue setSelectedIdea={setSelectedIdea} setCurrentView={setCurrentView} />,
        review: <ReviewQueue setSelectedIdea={setSelectedIdea} setCurrentView={setCurrentView} />,
        active: <ActiveIdeas setSelectedIdea={setSelectedIdea} setCurrentView={setCurrentView} />,
        appeals: <AppealsView />,
        archive: <ArchiveView setSelectedIdea={setSelectedIdea} setCurrentView={setCurrentView} />,
        detail: <IdeaDetail idea={selectedIdea} setCurrentView={setCurrentView} setSelectedIdea={setSelectedIdea} />,
        admin: <AdminApprovalView />
      };

      return <div className="flex min-h-screen bg-gray-50"><Sidebar currentView={currentView} setCurrentView={setCurrentView} /><div className="flex-1 overflow-auto">{views[currentView]}</div></div>;
    };

    // ============================================================================
    // ROOT
    // ============================================================================

    const App = () => <AuthProvider><IdeasProvider><AppContent /></IdeasProvider></AuthProvider>;
    const AppContent = () => {
      const { user, loading } = useAuth();
      if (loading) return <div className="min-h-screen bg-gray-50 flex items-center justify-center"><Loader2 className="animate-spin" size={40} style={{ color: '#007e8c' }} /></div>;
      if (!user) return <AuthForm />;
      // Check if user is approved (admins and existing users without the field are auto-approved)
      if (user.approved === false) return <PendingApprovalScreen />;
      return <MainApp />;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
